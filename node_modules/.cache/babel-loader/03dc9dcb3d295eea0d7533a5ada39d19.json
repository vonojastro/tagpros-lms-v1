{"ast":null,"code":"var _jsxFileName = \"/Users/vonojastro/Desktop/lms-frontend-v2/src/components/MailView/EmailComposer/index.jsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport { convertFromRaw, convertToRaw, EditorState } from 'draft-js';\nimport { getS3Url } from '../../../utils/teacherApplication';\nimport { FilePicker } from 'react-file-picker';\nimport { toast } from 'react-toastify';\nimport arrayMutators from 'final-form-arrays';\nimport _ from 'lodash';\nimport React, { useEffect, useState } from 'react';\nimport { Editor } from 'react-draft-wysiwyg';\nimport { Field, Form, useForm } from 'react-final-form';\nimport { useDispatch, useSelector } from 'react-redux';\nimport styled from 'styled-components';\nimport { getAllEmailDraftsOfUser, getAllEmailThreadsByUser, saveEmailDraft, sendEmail } from '../../../api/emailMessaging';\nimport useValidationSchema from '../../../hooks/use-validation-schema';\nimport AutocompleteInput from '../AutocompleteInput';\nimport editorProps from './editorProps';\nimport { fields } from './fields';\nimport SelectedRecipients from './SelectedRecipients';\nimport validator from './validator';\nimport { ContentState } from 'draft-js';\nimport { setActiveDraft, toggleEmailComposer } from 'redux/actions/mailView';\nimport { FieldArray } from 'react-final-form-arrays';\nimport S3 from 'aws-s3-pro';\nimport { s3Config } from '../../../config';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst s3Client = new S3(s3Config);\nconst FileAttachmentWrapper = styled.div`\n  display: grid;\n  gap: 0.5rem;\n  grid: 1fr / auto-flow 1fr auto;\n  & > div:first-child {\n    display: grid;\n    gap: 0.5rem;\n  }\n  & > *:nth-child(2) {\n    margin-top: auto;\n  }\n`;\n_c = FileAttachmentWrapper;\nexport const FileAttachment = props => {\n  var _fields$value, _fields$value2;\n\n  const {\n    fields,\n    viewOnly = false\n  } = props;\n\n  const handleChange = async f => {\n    console.log(f);\n\n    try {\n      fields.push(f);\n    } catch (error) {\n      console.log('ðŸš€ ~ file: index.jsx ~ line 44 ~ handleChange ~ error', error);\n    }\n  };\n\n  const handleClickRemoveFile = async i => {\n    fields.remove(i);\n  };\n\n  return /*#__PURE__*/_jsxDEV(FileAttachmentWrapper, {\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      children: fields === null || fields === void 0 ? void 0 : (_fields$value = fields.value) === null || _fields$value === void 0 ? void 0 : _fields$value.map((val, i) => /*#__PURE__*/_jsxDEV(\"a\", {\n        href: val.name ? URL.createObjectURL(val) : getS3Url(val),\n        target: \"_blank\",\n        rel: \"noreferrer\",\n        download: val.name || val,\n        style: {\n          display: 'grid',\n          grid: '1fr / minmax(100px, 200px) min-content',\n          gap: '0.5rem',\n          minWidth: 0\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          style: {\n            minWidth: 0\n          },\n          className: \"badge badge-secondary d-flex align-items-center justify-content-left text-truncate text-nowrap btn\",\n          children: val.name || val\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 77,\n          columnNumber: 13\n        }, this), !viewOnly && /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: e => {\n            e.preventDefault();\n            handleClickRemoveFile(i);\n          },\n          type: \"button\",\n          style: {\n            minWidth: 0\n          },\n          className: \"btn btn-sm btn-light\",\n          children: /*#__PURE__*/_jsxDEV(\"i\", {\n            className: \"fa fa-close\",\n            \"aria-hidden\": \"true\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 93,\n            columnNumber: 17\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 84,\n          columnNumber: 15\n        }, this)]\n      }, val.name || val, true, {\n        fileName: _jsxFileName,\n        lineNumber: 64,\n        columnNumber: 11\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 62,\n      columnNumber: 7\n    }, this), !viewOnly && /*#__PURE__*/_jsxDEV(FilePicker, {\n      maxSize: 25,\n      onChange: handleChange,\n      onError: () => {},\n      children: /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: e => e.preventDefault(),\n        type: \"button\",\n        disabled: (fields === null || fields === void 0 ? void 0 : (_fields$value2 = fields.value) === null || _fields$value2 === void 0 ? void 0 : _fields$value2.length) > 4,\n        className: \"btn btn-sm btn-info\",\n        children: [/*#__PURE__*/_jsxDEV(\"i\", {\n          className: \"fa fa-paperclip mr-2\",\n          \"aria-hidden\": \"true\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 108,\n          columnNumber: 13\n        }, this), \"Attach files\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 102,\n        columnNumber: 11\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 101,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 61,\n    columnNumber: 5\n  }, this);\n};\n_c2 = FileAttachment;\nconst LoadingIndicatorContainer = styled.div`\n  position: absolute;\n  height: 100%;\n  width: 100%;\n  display: grid;\n  align-items: center;\n  justify-content: center;\n  z-index: 100;\n  display: ${_ref => {\n  let {\n    show\n  } = _ref;\n  return !show && 'none';\n}};\n  pointer-events: ${_ref2 => {\n  let {\n    show\n  } = _ref2;\n  return !show && 'none';\n}};\n`;\n_c3 = LoadingIndicatorContainer;\n\nconst LoadingIndicator = _ref3 => {\n  let {\n    show\n  } = _ref3;\n  return /*#__PURE__*/_jsxDEV(LoadingIndicatorContainer, {\n    show: show,\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"spinner-border text-secondary\",\n      role: \"status\",\n      children: /*#__PURE__*/_jsxDEV(\"span\", {\n        className: \"sr-only\",\n        children: \"Loading...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 132,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 131,\n      columnNumber: 7\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 130,\n    columnNumber: 5\n  }, this);\n};\n\n_c4 = LoadingIndicator;\nexport const Container = styled.form`\n  display: grid;\n  grid-template-rows: auto 1fr;\n  height: 100%;\n  /* padding: 10px 20px; */\n  gap: 20px;\n  position: relative;\n`; // todo control editor input\n// todo control editor input\n\n_c5 = Container;\nexport const EmailComposerInputFields = styled.div`\n  /* padding: 10px 20px; */\n  display: grid;\n  gap: 10px;\n  flex-grow: 0;\n  & input {\n    height: 34px;\n    border: none;\n    border-radius: 4px;\n    background-color: white;\n    box-shadow: none;\n    /* z-index: 2; */\n  }\n`;\n_c6 = EmailComposerInputFields;\nconst StyledButton = styled.button`\n  width: min-content;\n  white-space: nowrap;\n`;\n_c7 = StyledButton;\nconst EditorContainer = styled.div`\n  position: relative;\n`;\n_c8 = EditorContainer;\nconst ButtonContainer = styled.div`\n  display: grid;\n  grid: 1fr / auto-flow;\n  & > button:nth-child(2) {\n    margin-left: auto;\n  }\n`;\n_c9 = ButtonContainer;\nconst AutocompleteResultWrapper = styled.div`\n  display: grid;\n  grid: 1fr / auto-flow auto 1fr;\n  gap: 0.5rem;\n  align-items: center;\n  img {\n    object-fit: cover;\n    object-position: center;\n    height: 2rem;\n    width: 2rem;\n    border-radius: 9999px;\n  }\n`;\n_c10 = AutocompleteResultWrapper;\nconst StyledInput = styled.input`\n  padding: 10px;\n`;\n_c11 = StyledInput;\n\nconst CustomEditor = _ref4 => {\n  _s();\n\n  let {\n    input,\n    activeDraft\n  } = _ref4;\n  const [editorState, setEditorState] = useState(EditorState.createWithContent(ContentState.createFromText('')));\n  useEffect(() => {\n    if (activeDraft) setEditorState(EditorState.createWithContent(convertFromRaw(activeDraft.mailContent))); // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [activeDraft === null || activeDraft === void 0 ? void 0 : activeDraft.mailContent]); // add 'value' to the dependency list to recalculate state when value changes.\n\n  const {\n    change\n  } = useForm();\n\n  const handleEditorStateChange = newState => {\n    setEditorState(newState);\n    change(input.name, newState);\n  };\n\n  return /*#__PURE__*/_jsxDEV(Editor, {\n    defaultEditorState: editorState,\n    editorState: editorState,\n    onEditorStateChange: handleEditorStateChange,\n    ...editorProps\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 218,\n    columnNumber: 5\n  }, this);\n};\n\n_s(CustomEditor, \"bFZS7wn3kJ0jeiw04HBxM4Lve5k=\", false, function () {\n  return [useForm];\n});\n\n_c12 = CustomEditor;\nexport const formatEmailFormValues = values => {\n  var _values$fields$mailRe;\n\n  return values ? { ...values,\n    [fields.mailReceiver.name]: (_values$fields$mailRe = values[fields.mailReceiver.name]) === null || _values$fields$mailRe === void 0 ? void 0 : _values$fields$mailRe.map(mr => mr === null || mr === void 0 ? void 0 : mr.senderId),\n    [fields.mailContent.name]: convertToRaw(values[fields.mailContent.name].getCurrentContent())\n  } : null;\n};\n\nfunction EmailComposer(_ref5) {\n  _s2();\n\n  let {\n    initialValues = {\n      [fields.mailSubject.name]: '',\n      [fields.mailReceiver.name]: [],\n      [fields.carbonCopy.name]: [],\n      [fields.blindCarbonCopy.name]: [],\n      [fields.mailAttachments.name]: []\n    },\n    handleSuccess\n  } = _ref5;\n  const [savingDraft, setSavingDraft] = useState(false);\n  const autocompleteSuggestions = useSelector(state => state.mailView.emailThreads.data);\n  const dispatch = useDispatch();\n\n  const fetchAutocompleteSuggestions = () => {\n    if (!autocompleteSuggestions.length) getAllEmailThreadsByUser(dispatch);\n  };\n\n  const FieldLabel = styled.h5``;\n  const validate = useValidationSchema(validator);\n\n  const submitDraft = async (values, initialize) => {\n    let requestPayload = formatEmailFormValues(values);\n    let mailAttachments = [];\n\n    try {\n      setSavingDraft(true);\n      if (values.mailAttachments && values.mailAttachments.length) mailAttachments = await Promise.all(values.mailAttachments.map(file => file.name ? s3Client.uploadFile(file, file.name).then(_ref6 => {\n        let {\n          key\n        } = _ref6;\n        return key;\n      }) : file));\n      console.log('ðŸš€ ~ file: index.jsx ~ line 247 ~ submitDraft ~ mailAttachments', mailAttachments);\n      requestPayload = { ...requestPayload,\n        mailAttachments\n      };\n      const {\n        threadId,\n        messageId\n      } = await saveEmailDraft(dispatch, requestPayload);\n      toast('Draft Saved.', {\n        type: 'info'\n      });\n      initialize({ ...values,\n        mailAttachments: [mailAttachments],\n        [fields.threadId.name]: threadId,\n        [fields.messageId.name]: messageId\n      });\n      getAllEmailDraftsOfUser(dispatch);\n    } catch (error) {\n      let errMsg = '';\n\n      if (error.response) {\n        errMsg = `Error: invalid request (${error.response.status})`;\n      } else if (error.request) {\n        errMsg = 'Error: no response from the server';\n        console.log(error.request);\n      } else {\n        errMsg = 'An unexpected error occurred';\n      }\n\n      console.log(error);\n      toast(errMsg, {\n        type: 'info'\n      });\n    } finally {\n      setSavingDraft(false);\n      dispatch(setActiveDraft(null));\n      dispatch(toggleEmailComposer(false));\n    }\n  };\n\n  const submit = async values => {\n    let requestPayload = formatEmailFormValues(values);\n    let mailAttachments = [];\n\n    try {\n      if (values.mailAttachments && values.mailAttachments.length) mailAttachments = await Promise.all(values.mailAttachments.map(file => file.name ? s3Client.uploadFile(file, file.name).then(_ref7 => {\n        let {\n          key\n        } = _ref7;\n        return key;\n      }) : file));\n      requestPayload = { ...requestPayload,\n        mailAttachments\n      };\n      await sendEmail(dispatch, requestPayload);\n      if (handleSuccess) handleSuccess(requestPayload);else {\n        getAllEmailThreadsByUser(dispatch);\n      }\n      toast('Email Sent Successfully', {\n        type: 'success'\n      });\n    } catch (error) {\n      console.log('ðŸš€ ~ file: index.jsx ~ line 305 ~ error', error);\n      let errMsg = '';\n\n      if (error.response) {\n        errMsg = `Error: invalid request (${error.response.status})`;\n      } else if (error.request) {\n        errMsg = 'Error: no response from the server';\n        console.log(error.request);\n      } else {\n        errMsg = 'An unexpected error occurred';\n      }\n\n      toast(errMsg, {\n        type: 'error'\n      });\n    }\n  };\n\n  const userAccountId = useSelector(state => {\n    var _state$auth, _state$auth$user;\n\n    return (_state$auth = state.auth) === null || _state$auth === void 0 ? void 0 : (_state$auth$user = _state$auth.user) === null || _state$auth$user === void 0 ? void 0 : _state$auth$user.accountId;\n  }); // eslint-disable-next-line eqeqeq\n\n  const isNotLoggedInUser = _ref8 => {\n    let {\n      senderId\n    } = _ref8;\n    return senderId != userAccountId;\n  };\n\n  const activeDraft = useSelector(state => state.mailView.activeDraft);\n  return /*#__PURE__*/_jsxDEV(Form, {\n    validate: validate,\n    mutators: { // potentially other mutators could be merged here\n      ...arrayMutators\n    },\n    initialValues: { ...initialValues,\n      [fields.mailContent.name]: EditorState.createEmpty()\n    },\n    onSubmit: submit,\n    render: _ref9 => {\n      let {\n        handleSubmit,\n        hasValidationErrors,\n        submitting,\n        form: {\n          initialize\n        },\n        dirty,\n        values\n      } = _ref9;\n      return /*#__PURE__*/_jsxDEV(Container, {\n        onSubmit: handleSubmit,\n        children: [/*#__PURE__*/_jsxDEV(LoadingIndicator, {\n          show: submitting\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 363,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(EmailComposerInputFields, {\n          children: [/*#__PURE__*/_jsxDEV(FieldLabel, {\n            children: fields.mailReceiver.label\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 365,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(AutocompleteInput, {\n            items: _.filter(_.uniqBy(autocompleteSuggestions, 'senderId'), isNotLoggedInUser),\n            formatResult: item => {\n              var _item$senderPhoto;\n\n              return /*#__PURE__*/_jsxDEV(AutocompleteResultWrapper, {\n                children: [/*#__PURE__*/_jsxDEV(\"img\", {\n                  alt: item.sender,\n                  src: ((_item$senderPhoto = item.senderPhoto) === null || _item$senderPhoto === void 0 ? void 0 : _item$senderPhoto.length) && item.senderPhoto || './assets/images/image-placeholder.jpg'\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 373,\n                  columnNumber: 19\n                }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n                  children: item.sender\n                }, void 0, false, {\n                  fileName: _jsxFileName,\n                  lineNumber: 380,\n                  columnNumber: 19\n                }, this)]\n              }, void 0, true, {\n                fileName: _jsxFileName,\n                lineNumber: 372,\n                columnNumber: 17\n              }, this);\n            },\n            fuseOptions: {\n              keys: ['sender']\n            },\n            onFocus: fetchAutocompleteSuggestions,\n            resultStringKeyName: \"sender\",\n            styling: {\n              height: '34px',\n              border: 'none',\n              borderRadius: '4px',\n              backgroundColor: 'white',\n              boxShadow: 'none'\n            },\n            ...fields.mailReceiver\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 366,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(SelectedRecipients, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 395,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(FieldLabel, {\n            children: fields.mailSubject.label\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 396,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(Field, {\n            name: fields.mailSubject.name,\n            children: props => /*#__PURE__*/_jsxDEV(StyledInput, { ...props.input,\n              ...fields.mailSubject\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 398,\n              columnNumber: 25\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 397,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 364,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(EditorContainer, {\n          children: /*#__PURE__*/_jsxDEV(Field, {\n            name: fields.mailContent.name,\n            activeDraft: activeDraft,\n            component: CustomEditor\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 402,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 401,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(FieldArray, {\n          name: fields.mailAttachments.name,\n          component: FileAttachment\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 408,\n          columnNumber: 11\n        }, this), /*#__PURE__*/_jsxDEV(ButtonContainer, {\n          children: [/*#__PURE__*/_jsxDEV(StyledButton, {\n            disabled: submitting || !dirty,\n            className: \"btn btn-info\",\n            type: \"button\",\n            onClick: _ => submitDraft(values, initialize),\n            children: \"Save Draft\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 410,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(StyledButton, {\n            disabled: hasValidationErrors || submitting || savingDraft,\n            className: \"btn btn-info btn-small\",\n            type: \"submit\",\n            children: \"Send Email\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 418,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 409,\n          columnNumber: 11\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 362,\n        columnNumber: 9\n      }, this);\n    }\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 343,\n    columnNumber: 5\n  }, this);\n}\n\n_s2(EmailComposer, \"dowtrju4YGoFFFl0ankURqjMiuc=\", false, function () {\n  return [useSelector, useDispatch, useValidationSchema, useSelector, useSelector];\n});\n\n_c13 = EmailComposer;\nexport default EmailComposer;\n\nvar _c, _c2, _c3, _c4, _c5, _c6, _c7, _c8, _c9, _c10, _c11, _c12, _c13;\n\n$RefreshReg$(_c, \"FileAttachmentWrapper\");\n$RefreshReg$(_c2, \"FileAttachment\");\n$RefreshReg$(_c3, \"LoadingIndicatorContainer\");\n$RefreshReg$(_c4, \"LoadingIndicator\");\n$RefreshReg$(_c5, \"Container\");\n$RefreshReg$(_c6, \"EmailComposerInputFields\");\n$RefreshReg$(_c7, \"StyledButton\");\n$RefreshReg$(_c8, \"EditorContainer\");\n$RefreshReg$(_c9, \"ButtonContainer\");\n$RefreshReg$(_c10, \"AutocompleteResultWrapper\");\n$RefreshReg$(_c11, \"StyledInput\");\n$RefreshReg$(_c12, \"CustomEditor\");\n$RefreshReg$(_c13, \"EmailComposer\");","map":{"version":3,"sources":["/Users/vonojastro/Desktop/lms-frontend-v2/src/components/MailView/EmailComposer/index.jsx"],"names":["convertFromRaw","convertToRaw","EditorState","getS3Url","FilePicker","toast","arrayMutators","_","React","useEffect","useState","Editor","Field","Form","useForm","useDispatch","useSelector","styled","getAllEmailDraftsOfUser","getAllEmailThreadsByUser","saveEmailDraft","sendEmail","useValidationSchema","AutocompleteInput","editorProps","fields","SelectedRecipients","validator","ContentState","setActiveDraft","toggleEmailComposer","FieldArray","S3","s3Config","s3Client","FileAttachmentWrapper","div","FileAttachment","props","viewOnly","handleChange","f","console","log","push","error","handleClickRemoveFile","i","remove","value","map","val","name","URL","createObjectURL","display","grid","gap","minWidth","e","preventDefault","length","LoadingIndicatorContainer","show","LoadingIndicator","Container","form","EmailComposerInputFields","StyledButton","button","EditorContainer","ButtonContainer","AutocompleteResultWrapper","StyledInput","input","CustomEditor","activeDraft","editorState","setEditorState","createWithContent","createFromText","mailContent","change","handleEditorStateChange","newState","formatEmailFormValues","values","mailReceiver","mr","senderId","getCurrentContent","EmailComposer","initialValues","mailSubject","carbonCopy","blindCarbonCopy","mailAttachments","handleSuccess","savingDraft","setSavingDraft","autocompleteSuggestions","state","mailView","emailThreads","data","dispatch","fetchAutocompleteSuggestions","FieldLabel","h5","validate","submitDraft","initialize","requestPayload","Promise","all","file","uploadFile","then","key","threadId","messageId","type","errMsg","response","status","request","submit","userAccountId","auth","user","accountId","isNotLoggedInUser","createEmpty","handleSubmit","hasValidationErrors","submitting","dirty","label","filter","uniqBy","item","sender","senderPhoto","keys","height","border","borderRadius","backgroundColor","boxShadow"],"mappings":"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","sourcesContent":["import { convertFromRaw, convertToRaw, EditorState } from 'draft-js';\nimport { getS3Url } from '../../../utils/teacherApplication';\nimport { FilePicker } from 'react-file-picker';\nimport { toast } from 'react-toastify';\nimport arrayMutators from 'final-form-arrays';\nimport _ from 'lodash';\nimport React, { useEffect, useState } from 'react';\nimport { Editor } from 'react-draft-wysiwyg';\nimport { Field, Form, useForm } from 'react-final-form';\nimport { useDispatch, useSelector } from 'react-redux';\nimport styled from 'styled-components';\n\nimport {\n  getAllEmailDraftsOfUser,\n  getAllEmailThreadsByUser,\n  saveEmailDraft,\n  sendEmail\n} from '../../../api/emailMessaging';\nimport useValidationSchema from '../../../hooks/use-validation-schema';\nimport AutocompleteInput from '../AutocompleteInput';\nimport editorProps from './editorProps';\nimport { fields } from './fields';\nimport SelectedRecipients from './SelectedRecipients';\nimport validator from './validator';\nimport { ContentState } from 'draft-js';\nimport { setActiveDraft, toggleEmailComposer } from 'redux/actions/mailView';\nimport { FieldArray } from 'react-final-form-arrays';\nimport S3 from 'aws-s3-pro';\nimport { s3Config } from '../../../config';\nconst s3Client = new S3(s3Config);\n\nconst FileAttachmentWrapper = styled.div`\n  display: grid;\n  gap: 0.5rem;\n  grid: 1fr / auto-flow 1fr auto;\n  & > div:first-child {\n    display: grid;\n    gap: 0.5rem;\n  }\n  & > *:nth-child(2) {\n    margin-top: auto;\n  }\n`;\nexport const FileAttachment = props => {\n  const { fields, viewOnly = false } = props;\n\n  const handleChange = async f => {\n    console.log(f);\n    try {\n      fields.push(f);\n    } catch (error) {\n      console.log('ðŸš€ ~ file: index.jsx ~ line 44 ~ handleChange ~ error', error);\n    }\n  };\n\n  const handleClickRemoveFile = async i => {\n    fields.remove(i);\n  };\n\n  return (\n    <FileAttachmentWrapper>\n      <div>\n        {fields?.value?.map((val, i) => (\n          <a\n            href={val.name ? URL.createObjectURL(val) : getS3Url(val)}\n            target=\"_blank\"\n            rel='noreferrer'\n            download={val.name || val}\n            key={val.name || val}\n            style={{\n              display: 'grid',\n              grid: '1fr / minmax(100px, 200px) min-content',\n              gap: '0.5rem',\n              minWidth: 0\n            }}\n          >\n            <div\n              style={{ minWidth: 0 }}\n              className='badge badge-secondary d-flex align-items-center justify-content-left text-truncate text-nowrap btn'\n            >\n              {val.name || val}\n            </div>\n            {!viewOnly && (\n              <button\n                onClick={e => {\n                  e.preventDefault();\n                  handleClickRemoveFile(i);\n                }}\n                type='button'\n                style={{ minWidth: 0 }}\n                className='btn btn-sm btn-light'\n              >\n                <i className='fa fa-close' aria-hidden='true' />\n              </button>\n            )}\n          </a>\n        ))}\n      </div>\n\n      {!viewOnly && (\n        <FilePicker maxSize={25} onChange={handleChange} onError={() => {}}>\n          <button\n            onClick={e => e.preventDefault()}\n            type='button'\n            disabled={fields?.value?.length > 4}\n            className='btn btn-sm btn-info'\n          >\n            <i className='fa fa-paperclip mr-2' aria-hidden='true' />\n            Attach files\n          </button>\n        </FilePicker>\n      )}\n    </FileAttachmentWrapper>\n  );\n};\n\nconst LoadingIndicatorContainer = styled.div`\n  position: absolute;\n  height: 100%;\n  width: 100%;\n  display: grid;\n  align-items: center;\n  justify-content: center;\n  z-index: 100;\n  display: ${({ show }) => !show && 'none'};\n  pointer-events: ${({ show }) => !show && 'none'};\n`;\nconst LoadingIndicator = ({ show }) => {\n  return (\n    <LoadingIndicatorContainer show={show}>\n      <div className='spinner-border text-secondary' role='status'>\n        <span className='sr-only'>Loading...</span>\n      </div>\n    </LoadingIndicatorContainer>\n  );\n};\n\nexport const Container = styled.form`\n  display: grid;\n  grid-template-rows: auto 1fr;\n  height: 100%;\n  /* padding: 10px 20px; */\n  gap: 20px;\n  position: relative;\n`;\n\n// todo control editor input\n// todo control editor input\n\nexport const EmailComposerInputFields = styled.div`\n  /* padding: 10px 20px; */\n  display: grid;\n  gap: 10px;\n  flex-grow: 0;\n  & input {\n    height: 34px;\n    border: none;\n    border-radius: 4px;\n    background-color: white;\n    box-shadow: none;\n    /* z-index: 2; */\n  }\n`;\n\nconst StyledButton = styled.button`\n  width: min-content;\n  white-space: nowrap;\n`;\nconst EditorContainer = styled.div`\n  position: relative;\n`;\nconst ButtonContainer = styled.div`\n  display: grid;\n  grid: 1fr / auto-flow;\n  & > button:nth-child(2) {\n    margin-left: auto;\n  }\n`;\n\nconst AutocompleteResultWrapper = styled.div`\n  display: grid;\n  grid: 1fr / auto-flow auto 1fr;\n  gap: 0.5rem;\n  align-items: center;\n  img {\n    object-fit: cover;\n    object-position: center;\n    height: 2rem;\n    width: 2rem;\n    border-radius: 9999px;\n  }\n`;\nconst StyledInput = styled.input`\n  padding: 10px;\n`;\n\nconst CustomEditor = ({ input, activeDraft }) => {\n  const [editorState, setEditorState] = useState(\n    EditorState.createWithContent(ContentState.createFromText(''))\n  );\n\n  useEffect(() => {\n    if (activeDraft)\n      setEditorState(\n        EditorState.createWithContent(convertFromRaw(activeDraft.mailContent))\n      );\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [activeDraft?.mailContent]); // add 'value' to the dependency list to recalculate state when value changes.\n\n  const { change } = useForm();\n\n  const handleEditorStateChange = newState => {\n    setEditorState(newState);\n    change(input.name, newState);\n  };\n\n  return (\n    <Editor\n      defaultEditorState={editorState}\n      editorState={editorState}\n      onEditorStateChange={handleEditorStateChange}\n      {...editorProps}\n    />\n  );\n};\nexport const formatEmailFormValues = values =>\n  values\n    ? {\n        ...values,\n        [fields.mailReceiver.name]: values[fields.mailReceiver.name]?.map(\n          mr => mr?.senderId\n        ),\n        [fields.mailContent.name]: convertToRaw(\n          values[fields.mailContent.name].getCurrentContent()\n        )\n      }\n    : null;\n\nfunction EmailComposer({\n  initialValues = {\n    [fields.mailSubject.name]: '',\n    [fields.mailReceiver.name]: [],\n    [fields.carbonCopy.name]: [],\n    [fields.blindCarbonCopy.name]: [],\n    [fields.mailAttachments.name]: []\n  },\n  handleSuccess\n}) {\n  const [savingDraft, setSavingDraft] = useState(false);\n  const autocompleteSuggestions = useSelector(state => state.mailView.emailThreads.data);\n  const dispatch = useDispatch();\n\n  const fetchAutocompleteSuggestions = () => {\n    if (!autocompleteSuggestions.length) getAllEmailThreadsByUser(dispatch);\n  };\n  const FieldLabel = styled.h5``;\n\n  const validate = useValidationSchema(validator);\n\n  const submitDraft = async (values, initialize) => {\n    let requestPayload = formatEmailFormValues(values);\n    let mailAttachments = [];\n    try {\n      setSavingDraft(true);\n      if (values.mailAttachments && values.mailAttachments.length)\n        mailAttachments = await Promise.all(\n          values.mailAttachments.map(file =>\n            file.name ? s3Client.uploadFile(file, file.name).then(({ key }) => key) : file\n          )\n        );\n      console.log(\n        'ðŸš€ ~ file: index.jsx ~ line 247 ~ submitDraft ~ mailAttachments',\n        mailAttachments\n      );\n      requestPayload = { ...requestPayload, mailAttachments };\n      const { threadId, messageId } = await saveEmailDraft(dispatch, requestPayload);\n      toast('Draft Saved.', { type: 'info' });\n      initialize({\n        ...values,\n        mailAttachments: [mailAttachments],\n        [fields.threadId.name]: threadId,\n        [fields.messageId.name]: messageId\n      });\n      getAllEmailDraftsOfUser(dispatch);\n    } catch (error) {\n      let errMsg = '';\n      if (error.response) {\n        errMsg = `Error: invalid request (${error.response.status})`;\n      } else if (error.request) {\n        errMsg = 'Error: no response from the server';\n        console.log(error.request);\n      } else {\n        errMsg = 'An unexpected error occurred';\n      }\n      console.log(error);\n      toast(errMsg, { type: 'info' });\n    } finally {\n      setSavingDraft(false);\n      dispatch(setActiveDraft(null));\n      dispatch(toggleEmailComposer(false));\n    }\n  };\n\n  const submit = async values => {\n    let requestPayload = formatEmailFormValues(values);\n    let mailAttachments = [];\n    try {\n      if (values.mailAttachments && values.mailAttachments.length)\n        mailAttachments = await Promise.all(\n          values.mailAttachments.map(file =>\n            file.name ? s3Client.uploadFile(file, file.name).then(({ key }) => key) : file\n          )\n        );\n      requestPayload = { ...requestPayload, mailAttachments };\n      await sendEmail(dispatch, requestPayload);\n      if (handleSuccess) handleSuccess(requestPayload);\n      else {\n        getAllEmailThreadsByUser(dispatch);\n      }\n\n      toast('Email Sent Successfully', { type: 'success' });\n    } catch (error) {\n      console.log('ðŸš€ ~ file: index.jsx ~ line 305 ~ error', error);\n      let errMsg = '';\n      if (error.response) {\n        errMsg = `Error: invalid request (${error.response.status})`;\n      } else if (error.request) {\n        errMsg = 'Error: no response from the server';\n        console.log(error.request);\n      } else {\n        errMsg = 'An unexpected error occurred';\n      }\n\n      toast(errMsg, { type: 'error' });\n    }\n  };\n  const userAccountId = useSelector(state => state.auth?.user?.accountId);\n  // eslint-disable-next-line eqeqeq\n  const isNotLoggedInUser = ({ senderId }) => senderId != userAccountId;\n  const activeDraft = useSelector(state => state.mailView.activeDraft);\n\n  return (\n    <Form\n      validate={validate}\n      mutators={{\n        // potentially other mutators could be merged here\n        ...arrayMutators\n      }}\n      initialValues={{\n        ...initialValues,\n        [fields.mailContent.name]: EditorState.createEmpty()\n      }}\n      onSubmit={submit}\n      render={({\n        handleSubmit,\n        hasValidationErrors,\n        submitting,\n        form: { initialize },\n        dirty,\n        values\n      }) => (\n        <Container onSubmit={handleSubmit}>\n          <LoadingIndicator show={submitting} />\n          <EmailComposerInputFields>\n            <FieldLabel>{fields.mailReceiver.label}</FieldLabel>\n            <AutocompleteInput\n              items={_.filter(\n                _.uniqBy(autocompleteSuggestions, 'senderId'),\n                isNotLoggedInUser\n              )}\n              formatResult={item => (\n                <AutocompleteResultWrapper>\n                  <img\n                    alt={item.sender}\n                    src={\n                      (item.senderPhoto?.length && item.senderPhoto) ||\n                      './assets/images/image-placeholder.jpg'\n                    }\n                  />\n                  <div>{item.sender}</div>\n                </AutocompleteResultWrapper>\n              )}\n              fuseOptions={{ keys: ['sender'] }}\n              onFocus={fetchAutocompleteSuggestions}\n              resultStringKeyName='sender'\n              styling={{\n                height: '34px',\n                border: 'none',\n                borderRadius: '4px',\n                backgroundColor: 'white',\n                boxShadow: 'none'\n              }}\n              {...fields.mailReceiver}\n            />\n            <SelectedRecipients />\n            <FieldLabel>{fields.mailSubject.label}</FieldLabel>\n            <Field name={fields.mailSubject.name}>\n              {props => <StyledInput {...props.input} {...fields.mailSubject} />}\n            </Field>\n          </EmailComposerInputFields>\n          <EditorContainer>\n            <Field\n              name={fields.mailContent.name}\n              activeDraft={activeDraft}\n              component={CustomEditor}\n            />\n          </EditorContainer>\n          <FieldArray name={fields.mailAttachments.name} component={FileAttachment} />\n          <ButtonContainer>\n            <StyledButton\n              disabled={submitting || !dirty}\n              className='btn btn-info'\n              type='button'\n              onClick={_ => submitDraft(values, initialize)}\n            >\n              Save Draft\n            </StyledButton>\n            <StyledButton\n              disabled={hasValidationErrors || submitting || savingDraft}\n              className='btn btn-info btn-small'\n              type='submit'\n            >\n              Send Email\n            </StyledButton>\n          </ButtonContainer>\n        </Container>\n      )}\n    />\n  );\n}\n\nexport default EmailComposer;\n"]},"metadata":{},"sourceType":"module"}